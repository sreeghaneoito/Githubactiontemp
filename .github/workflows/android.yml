name: Android

on: [push]

jobs:
  build:
    runs-on: macos-12
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v1
        with:
          fetch-depth: 1

      - name: Node
        uses: actions/setup-node@v3
        with:
          node-version: "18.16"

      - name: Install dependencies with npm or Yarn
        run: |
          if [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Run tests
        run: |
          if [ -f "yarn.lock" ]; then
            yarn test
          else
            npm test
          fi

      - name: Use specific Java version for sdkmanager to work
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "11"
          architecture: "x64"

      - name: Install node_modules
        run: |
          yarn install

      - name: Android Detox
        run: yarn run start && yarn run cucumber_release

      - name: Store Detox artifacts on test failure
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: detox-artifacts
